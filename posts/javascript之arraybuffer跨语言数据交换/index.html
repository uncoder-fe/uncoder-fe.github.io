<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>javascript之Arraybuffer跨语言数据交换 | 不三之选</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="
If you can&rsquo;t explain it simply, you don&rsquo;t understand it well enough.
Albert Einstein
"><meta name=generator content="Hugo 0.111.3"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="javascript之Arraybuffer跨语言数据交换"><meta property="og:description" content="
If you can&rsquo;t explain it simply, you don&rsquo;t understand it well enough.
Albert Einstein
"><meta property="og:type" content="article"><meta property="og:url" content="/posts/javascript%E4%B9%8Barraybuffer%E8%B7%A8%E8%AF%AD%E8%A8%80%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-13T16:01:25+08:00"><meta property="article:modified_time" content="2020-08-13T16:01:25+08:00"><meta itemprop=name content="javascript之Arraybuffer跨语言数据交换"><meta itemprop=description content="
If you can&rsquo;t explain it simply, you don&rsquo;t understand it well enough.
Albert Einstein
"><meta itemprop=datePublished content="2020-08-13T16:01:25+08:00"><meta itemprop=dateModified content="2020-08-13T16:01:25+08:00"><meta itemprop=wordCount content="410"><meta itemprop=keywords content="Arraybuffer,"><meta name=twitter:card content="summary"><meta name=twitter:title content="javascript之Arraybuffer跨语言数据交换"><meta name=twitter:description content="
If you can&rsquo;t explain it simply, you don&rsquo;t understand it well enough.
Albert Einstein
"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-gray><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">不三之选</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Posts page">Posts</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">javascript之Arraybuffer跨语言数据交换</h1><p class=tracked>By <strong>uncoder-fe</strong></p><time class="f6 mv4 dib tracked" datetime=2020-08-13T16:01:25+08:00>August 13, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><blockquote><p>If you can&rsquo;t explain it simply, you don&rsquo;t understand it well enough.
Albert Einstein</p></blockquote><h1 id=概念>概念</h1><p>前端视角来看，ArrayBuffer 对象用来表示通用的、固定长度的原始二进制数据缓冲区。
其他语言中称为byte array，它是一个字节数组。</p><p>举个栗子：常见的文件下载/图像下载，这里使用一个icon当作资源地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#39;https://s3.pstatp.com/ee/feishu_website/static/img/logo-zh.648d6d020e.webp&#39;</span>, { <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;get&#39;</span> })
</span></span><span style=display:flex><span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>response</span>=&gt;<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>arrayBuffer</span>())<span style=color:#75715e>// 可选blob()，这里只做对buffer类型的设定，也有其他类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>arrybuffer</span>=&gt;{ <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>arrybuffer</span>) });
</span></span></code></pre></div><p>浏览器控制台直接拷贝以上代码，并回车执行，结果如下。</p><p>聪明的你已经发现了奇怪的事，Int8Array / Int16Array / Uint8Array这些东西，其实是一样的(也是不一样的)，同一份buffer的不同编码格式的类数组(TypedArray)，可以看到每种类型后面的长度（字节个数），3462 = 1731*2。还可以看到arraybuffer的长度和Int8Array的长度一样，都是3462，这个点可以注意一下。</p><h2 id=typedarray>typedArray</h2><p>一个类型化数组（TypedArray）对象描述了一个底层的二进制数据缓冲区（binary data buffer）的一个类数组视图（view）。</p><h2 id=16进制数据>16进制数据</h2><p>16进制数据(简写为hex，在数学中是一种逢16进1的进位制)。举个例子, 红色的阴影是十进制 238,9,63 ，或者rgb(238, 9, 63)，可以编成 #ee093f。</p><p>做过加密比如(AES)的同学应该知道base64与hex是常用的格式，思考，为啥用这种方式呢？</p><h1 id=生成arraybuffer>生成arraybuffer</h1><p>你不能直接操作<code>ArrayBuffer</code>的内容，而是要通过类型数组对象（TypedArray）或 DataView 对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。
利用构造函数创建一个ArrayBuffer对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>arrybuffer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ArrayBuffer</span>(<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>length</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>要创建的</span> <span style=color:#a6e22e>ArrayBuffer</span> <span style=color:#a6e22e>的大小</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>单位为字节</span><span style=color:#960050;background-color:#1e0010>（</span><span style=color:#a6e22e>Byte</span><span style=color:#960050;background-color:#1e0010>）。</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>arrybuffer</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>一个指定大小的</span> <span style=color:#a6e22e>ArrayBuffer</span> <span style=color:#a6e22e>对象</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>其内容被初始化为0</span><span style=color:#960050;background-color:#1e0010>。</span>
</span></span></code></pre></div><h2 id=字节>字节</h2><p>没有跳动，这个计算机术语是个旧词汇，下面掰扯一下。</p><h3 id=字节英语byte通常用作计算机信息计量单位不分数据类型从历史的观点上字节表示用于编码单个字符所需要的比特数量今日事实标准以8比特作为一字节因8为二进制整数每个数字称为一个比特二进制位或比特bitbinary-digit-的缩写缩写为b>字节（英语：Byte），通常用作计算机信息计量单位，不分数据类型。从历史的观点上，“字节”表示用于编码单个字符所需要的比特数量。今日事实标准以8比特作为一字节，因8为二进制整数（每个数字称为一个比特（二进制位）或比特（Bit，Binary digit 的缩写））。缩写为B</h3><p>可以看到，进制越大越短，传输数据越少。一个字节最大值（8位）的十进制表示为255，是不是很熟悉的一个数字。</p><h3 id=比特>比特</h3><p>（英语：Bit，亦称二进制位）指二进制中的一位，是信息的最小单位。缩写为b</p><h2 id=unicode>Unicode</h2><p>（中文：万国码、国际码、统一码、单一码）是计算机科学领域里的一项业界标准。它对世界上大部分的文字系统进行了整理、编码，使得电脑可以用更为简单的方式来呈现和处理文字。当前最新的版本为2019年5月公布的12.1.0，已经收录超过13万个字符。Unicode涵盖的数据除了视觉上的字形、编码方法、标准的字符编码外，还包含了字符特性，如大小写字母。</p><p>在文字处理方面，统一码为每一个字符而非字形定义唯一的代码（即一个整数，十进制）。</p><p>在表示一个 Unicode 的字符时，通常会用“U+”然后紧接着一组十六进制的数字来表示这一个字符。</p><p>比如栗子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;中&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>str</span>.<span style=color:#a6e22e>charCodeAt</span>(); 
</span></span><span style=display:flex><span><span style=color:#75715e>// 二进制表示，100111000101101
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 十进制表示，20013
</span></span></span><span style=display:flex><span><span style=color:#75715e>// UTF-16 code units，4e2d
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>String.<span style=color:#a6e22e>fromCharCode</span>(<span style=color:#a6e22e>i</span>);  <span style=color:#75715e>// &#34;中&#34;
</span></span></span></code></pre></div><p>Unicode 的实现方式称为 Unicode转换格式（Unicode Transformation Format，简称为 UTF）</p><h3 id=utf-8>UTF-8</h3><p>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字符编码，也是一种前缀码。它可以用一至四个字节对Unicode字符集中的所有有效编码点进行编码，属于Unicode标准的一部分，最初由肯·汤普逊和罗布·派克提出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span>  <span style=color:#75715e>// 此行没有意义，方便观看对比
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 4e2d，在第三个范围，需要用三个字节（3 * 8）24位表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>100</span> <span style=color:#ae81ff>1110</span> <span style=color:#ae81ff>0010</span> <span style=color:#ae81ff>1101</span>  <span style=color:#75715e>// 二进制
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1110</span><span style=color:#a6e22e>xxxx</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>xxxxxx</span> <span style=color:#ae81ff>10</span><span style=color:#a6e22e>xxxxxx</span> <span style=color:#75715e>// 替换上面的x，位说不够x变为0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>11100100</span> <span style=color:#ae81ff>10111000</span> <span style=color:#ae81ff>10101101</span> <span style=color:#75715e>//转换为UTF-8分组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>e4</span>       <span style=color:#a6e22e>b8</span>       <span style=color:#a6e22e>ad</span>  <span style=color:#75715e>//转换为UTF-8分组，16进制表示  
</span></span></span></code></pre></div><p>起点/终点，16进制表示</p><h3 id=utf-16>UTF-16</h3><p>计算太复杂了，不说了</p><h2 id=从base64创建一个arrybuffer对象>从base64创建一个ArryBuffer对象</h2><p>首先我们获取一个base64的字符串，常规操作，见证奇迹。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;中&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>barse64Str</span> <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>btoa</span>(<span style=color:#a6e22e>str</span>); <span style=color:#75715e>//啊哦，浏览器报错了 The string to be encoded contains characters outside of the Latin1 range.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>报错了</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>很尴尬</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>有人知道为什么嘛</span><span style=color:#960050;background-color:#1e0010>？</span>
</span></span></code></pre></div><h3 id=base64>base64</h3><p>Base64 是一组相似的二进制到文本（binary-to-text）的编码规则，使得二进制数据在解释成 radix-64 的表现形式后能够用 ASCII 字符串的格式表示出来。</p><h3 id=ascii>ASCII</h3><p>American Standard Code for Information Interchange是基于拉丁字母的一套电脑编码系统。局限在于只能显示26个基本拉丁字母、阿拉伯数字和英式标点符号，因此只能用于显示现代美国英语。
问题原因，这样处理。
由于 DOMString 或者 String 是16位编码的字符串，所以如果有字符超出了8位ASCII编码的字符范围时，在大多数的浏览器中对Unicode字符串调用 window.btoa 将会造成一个 Character Out Of Range 的异常。</p><p>有很多种方法可以解决这个问题：高位转低位
这里我们使用第三个方法，原因是代码短 / 小 / 便携，你懂的😈</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// 编码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>btoaUTF16</span>(<span style=color:#a6e22e>sString</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 先声明一个无符号16位的类数组，可理解为承载容器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>aUTF16CodeUnits</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint16Array</span>(<span style=color:#a6e22e>sString</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 容器装填每个字符对应的索引值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Array.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>forEach</span>.<span style=color:#a6e22e>call</span>(<span style=color:#a6e22e>aUTF16CodeUnits</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>el</span>, <span style=color:#a6e22e>idx</span>, <span style=color:#a6e22e>arr</span>) {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>arr</span>[<span style=color:#a6e22e>idx</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>sString</span>.<span style=color:#a6e22e>charCodeAt</span>(<span style=color:#a6e22e>idx</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 无符号16位类数组 转为 无符号8位类数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>array</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>(<span style=color:#a6e22e>aUTF16CodeUnits</span>.<span style=color:#a6e22e>buffer</span>); <span style=color:#75715e>// Uint8Array(6) [45, 78, 253, 86, 166, 104]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>str</span> <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>fromCharCode</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>array</span>); <span style=color:#75715e>// 错误的字符串，-NýV¦h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 返回base64字符串
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> window.<span style=color:#a6e22e>btoa</span>(<span style=color:#a6e22e>str</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resultBase64</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>btoaUTF16</span>(<span style=color:#e6db74>&#39;中国梦&#39;</span>); <span style=color:#75715e>// &#39;LU79VqZo&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>atobUTF16</span>(<span style=color:#a6e22e>sBase64</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解码base64
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sBinaryString</span> <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>atob</span>(<span style=color:#a6e22e>sBase64</span>);  <span style=color:#75715e>//-NýV¦h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 创建8位类数组，可理解为承载容器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>aBinaryView</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>(<span style=color:#a6e22e>sBinaryString</span>.<span style=color:#a6e22e>length</span>); 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 容器装填每个字符对应的索引值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Array.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>forEach</span>.<span style=color:#a6e22e>call</span>(<span style=color:#a6e22e>aBinaryView</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>el</span>, <span style=color:#a6e22e>idx</span>, <span style=color:#a6e22e>arr</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>arr</span>[<span style=color:#a6e22e>idx</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>sBinaryString</span>.<span style=color:#a6e22e>charCodeAt</span>(<span style=color:#a6e22e>idx</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Uint8Array(6) [45, 78, 253, 86, 166, 104]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 正确的字符串
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> String.<span style=color:#a6e22e>fromCharCode</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint16Array</span>(<span style=color:#a6e22e>aBinaryView</span>.<span style=color:#a6e22e>buffer</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>atobUTF16</span>(<span style=color:#e6db74>&#39;LU79VqZo&#39;</span>); <span style=color:#75715e>// &#39;中国梦&#39;
</span></span></span></code></pre></div><p>到此base64创建arraybuffer已经结束了，啥，你没看明白？看来你没注意听讲啊.</p><h2 id=从字符串创建一个arraybuffer>从字符串创建一个ArrayBuffer</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>enc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TextEncoder</span>(); <span style=color:#75715e>// always utf-8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>arry</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>encode</span>(<span style=color:#e6db74>&#39;中国梦&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>arry</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dnc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TextDecoder</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>dnc</span>.<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>arry</span>))
</span></span></code></pre></div><h2 id=从blob创建一个arraybuffer>从blob创建一个ArrayBuffer</h2><p>使用开头我们的栗子，直接发起请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#39;https://s3.pstatp.com/ee/feishu_website/static/img/logo-zh.648d6d020e.webp&#39;</span>, { <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;get&#39;</span> })
</span></span><span style=display:flex><span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>response</span> =&gt; <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>blob</span>())
</span></span><span style=display:flex><span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>blob</span> =&gt; { <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>blob</span>) });
</span></span></code></pre></div><p>控制台执行，输入如下</p><p>不错不错，已经有blob对象了，下一步就非常简单了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>blob</span>.<span style=color:#a6e22e>arrayBuffer</span>();
</span></span></code></pre></div><h2 id=思考既然blob创建buffer这么简单那或许可以利用一下>思考，既然blob创建buffer这么简单，那或许可以利用一下</h2><p>创建一个blob对象，然后塞入一个字符串</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>blob</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Blob</span>([<span style=color:#e6db74>&#39;中国梦&#39;</span>], {<span style=color:#a6e22e>type</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;plain/text&#39;</span>});
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>blob</span>.<span style=color:#a6e22e>arrayBuffer</span>();
</span></span></code></pre></div><p>似乎，好像，可以</p><h1 id=反转arraybuffer为数据>反转arraybuffer为数据</h1><h2 id=转-string>转 string</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ab2str</span>(<span style=color:#a6e22e>buf</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> String.<span style=color:#a6e22e>fromCharCode</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint16Array</span>(<span style=color:#a6e22e>buf</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=转--blob--转-object>转 blob 转 object</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>blob</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Blob</span>([<span style=color:#a6e22e>arraybuffer</span><span style=color:#f92672>||</span><span style=color:#a6e22e>typedArray</span>]);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reader</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>FileReader</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>reader</span>.<span style=color:#a6e22e>readAsText</span>(<span style=color:#a6e22e>blob</span>, <span style=color:#e6db74>&#39;utf-16&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>reader</span>.<span style=color:#a6e22e>onload</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>info</span>(<span style=color:#a6e22e>reader</span>.<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=转--string>转 string</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TextDecoder</span>(<span style=color:#e6db74>&#39;utf-16&#39;</span>).<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>typedArray</span>)
</span></span></code></pre></div><h1 id=备注>备注</h1><p>表单上传的时候，推荐使用typedArray。</p><ul class=pa0><li class="list di"><a href=/tags/arraybuffer/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Arraybuffer</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-dark-gray bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=/>&copy; 不三之选 2023</a><div><div class=ananke-socials></div></div></div></footer></body></html>